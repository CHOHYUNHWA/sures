<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}"
      lang="ko">
<head>
    <title>예약 관리</title>
    <style>
        /* 모바일 기본 검색 */
        .mobile-search-basic {
            margin-bottom: 0.5rem;
        }

        /* 개선된 예약 카드 */
        .reservation-card {
            background: #fff;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 0;
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .reservation-card:active {
            transform: scale(0.99);
        }
        .reservation-card:last-child {
            margin-bottom: 0;
        }

        /* 카드 상단: 날짜/시간 + 상태 */
        .reservation-card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--color-primary) 0%, #022a6e 100%);
            color: #fff;
        }
        .reservation-card-datetime-main {
            font-size: 1rem;
            font-weight: 600;
        }
        .reservation-card-datetime-main .date {
            margin-right: 0.5rem;
        }
        .reservation-card-datetime-main .time {
            font-size: 1.1rem;
            color: var(--color-accent);
        }
        .reservation-card-status {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        .reservation-card-status.confirmed { background: var(--color-accent); color: #fff; }
        .reservation-card-status.completed { background: #28a745; color: #fff; }
        .reservation-card-status.cancelled { background: #dc3545; color: #fff; }
        .reservation-card-status.no_show { background: #6c757d; color: #fff; }

        /* 카드 본문 */
        .reservation-card-body {
            padding: 1rem;
        }
        .reservation-card-customer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .reservation-card-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary);
        }
        .reservation-card-type-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: rgba(40, 167, 225, 0.1);
            color: var(--color-accent);
            border-radius: 4px;
            font-weight: 500;
        }
        .reservation-card-contact {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .reservation-card-contact svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }
        .reservation-card-number {
            font-size: 0.75rem;
            color: #999;
        }

        /* 카드 액션 */
        .reservation-card-action {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-top: 1px solid var(--color-border);
        }
        .reservation-card-action .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* 모바일 레이아웃 기본 */
        .table-desktop { display: none; }
        .reservation-cards {
            display: block;
            padding: 0;
        }

        /* 데스크탑용 날짜 필터 숨김 - 모바일 스타일 통일 */
        .date-range-desktop {
            display: none !important;
        }
    </style>
</head>
<body>
    <th:block layout:fragment="page-content">
        <div class="page-header">
            <h1>예약 관리</h1>
            <a th:href="@{/admin/reservations/new}" class="btn btn-primary">+ 새 예약</a>
        </div>

        <!-- 성공/에러 메시지 -->
        <div th:if="${success}" class="alert alert-success">
            <span th:text="${success}">성공 메시지</span>
        </div>
        <div th:if="${error}" class="alert alert-error">
            <span th:text="${error}">에러 메시지</span>
        </div>

        <!-- 검색 필터 -->
        <div class="card mb-3">
            <div class="card-body">
                <form th:action="@{/admin/reservations}" method="get" id="searchForm">
                    <!-- 모바일: 기본 검색 (항상 표시) -->
                    <div class="mobile-search-basic">
                        <input type="text" class="form-input" name="keyword" th:value="${searchKeyword}" placeholder="이름/연락처/예약번호 검색">
                    </div>

                    <!-- 모바일: 상세 필터 토글 버튼 -->
                    <button type="button" class="filter-toggle" onclick="toggleFilter()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"></polygon>
                        </svg>
                        상세 필터
                    </button>

                    <!-- 필터 콘텐츠 (모바일: 접힘, 데스크탑: 항상 표시) -->
                    <div class="filter-content" id="filterContent">
                        <!-- 상태 필터 -->
                        <div class="filter-group">
                            <select class="form-select" name="status">
                                <option value="">전체 상태</option>
                                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s.description}" th:selected="${searchStatus == s}">상태</option>
                            </select>
                        </div>

                        <!-- 날짜 필터 - 모바일용 -->
                        <div class="date-filter-mobile">
                            <span class="date-filter-label">기간 선택</span>
                            <div class="date-inputs">
                                <div class="date-input-group">
                                    <label>시작</label>
                                    <input type="date" class="form-input" name="startDate" th:value="${searchStartDate}">
                                </div>
                                <div class="date-input-group">
                                    <label>종료</label>
                                    <input type="date" class="form-input" name="endDate" th:value="${searchEndDate}">
                                </div>
                            </div>
                            <!-- 퀵 필터 -->
                            <div class="quick-filters">
                                <button type="button" class="quick-filter-btn" onclick="setDateRange('today')">오늘</button>
                                <button type="button" class="quick-filter-btn" onclick="setDateRange('week')">이번 주</button>
                                <button type="button" class="quick-filter-btn" onclick="setDateRange('month')">이번 달</button>
                            </div>
                        </div>

                        <!-- 날짜 필터 - 데스크탑용 -->
                        <div class="date-range date-range-desktop">
                            <input type="date" class="form-input" name="startDateDesktop" th:value="${searchStartDate}">
                            <span class="date-separator">~</span>
                            <input type="date" class="form-input" name="endDateDesktop" th:value="${searchEndDate}">
                        </div>

                        <!-- 검색/초기화 버튼 -->
                        <div class="search-actions">
                            <button type="submit" class="btn btn-accent">검색</button>
                            <a th:href="@{/admin/reservations}" class="btn btn-outline">초기화</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 예약 목록 -->
        <div class="card">
            <!-- 데스크탑 테이블 -->
            <div class="table-desktop">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>예약번호</th>
                                <th>예약자</th>
                                <th>연락처</th>
                                <th>상담일시</th>
                                <th>상담유형</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${reservations.content.empty}">
                                <td colspan="7" style="text-align: center; padding: 2rem; color: #999;">
                                    예약 내역이 없습니다.
                                </td>
                            </tr>
                            <tr th:each="reservation : ${reservations.content}">
                                <td th:text="${reservation.reservationNumber}">R20260120001</td>
                                <td th:text="${reservation.customerName}">홍길동</td>
                                <td th:text="${reservation.phone}">010-1234-5678</td>
                                <td>
                                    <span th:text="${#temporals.format(reservation.reservationDate, 'yyyy-MM-dd')}">2026-01-25</span>
                                    <span th:text="${#temporals.format(reservation.reservationTime, 'HH:mm')}">14:00</span>
                                </td>
                                <td th:text="${reservation.consultationType.description}">종합소득세</td>
                                <td>
                                    <span th:style="${reservation.status.name() == 'CONFIRMED' ? 'color: var(--color-accent); font-weight: 600;' :
                                                      reservation.status.name() == 'COMPLETED' ? 'color: #28a745; font-weight: 600;' :
                                                      reservation.status.name() == 'CANCELLED' ? 'color: #dc3545; font-weight: 600;' :
                                                      'color: #6c757d; font-weight: 600;'}"
                                          th:text="${reservation.status.description}">확정</span>
                                </td>
                                <td>
                                    <a th:href="@{/admin/reservations/{id}(id=${reservation.id})}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                        상세
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 모바일 카드 리스트 -->
            <div class="reservation-cards">
                <div th:if="${reservations.content.empty}" style="text-align: center; padding: 2rem; color: #999;">
                    예약 내역이 없습니다.
                </div>
                <a th:each="reservation : ${reservations.content}"
                   th:href="@{/admin/reservations/{id}(id=${reservation.id})}"
                   class="reservation-card" style="text-decoration: none; display: block;">
                    <!-- 카드 상단: 날짜/시간 + 상태 -->
                    <div class="reservation-card-top">
                        <div class="reservation-card-datetime-main">
                            <span class="date" th:text="${#temporals.format(reservation.reservationDate, 'MM/dd (E)')}">01/25 (토)</span>
                            <span class="time" th:text="${#temporals.format(reservation.reservationTime, 'HH:mm')}">14:00</span>
                        </div>
                        <span th:class="'reservation-card-status ' + ${reservation.status.name().toLowerCase()}"
                              th:text="${reservation.status.description}">확정</span>
                    </div>
                    <!-- 카드 본문 -->
                    <div class="reservation-card-body">
                        <div class="reservation-card-customer">
                            <span class="reservation-card-name" th:text="${reservation.customerName}">홍길동</span>
                            <span class="reservation-card-type-badge" th:text="${reservation.consultationType.description}">종합소득세</span>
                        </div>
                        <div class="reservation-card-contact">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            <span th:text="${reservation.phone}">010-1234-5678</span>
                        </div>
                        <div class="reservation-card-number" th:text="${reservation.reservationNumber}">R20260120001</div>
                    </div>
                </a>
            </div>

            <!-- 페이징 -->
            <div th:if="${reservations.totalPages > 1}" style="padding: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
                <a th:if="${!reservations.first}"
                   th:href="@{/admin/reservations(page=${reservations.page - 1}, status=${searchStatus}, startDate=${searchStartDate}, endDate=${searchEndDate}, keyword=${searchKeyword})}"
                   class="btn btn-outline" style="padding: 0.25rem 0.75rem;">이전</a>
                <span style="padding: 0.25rem 0.75rem; color: #666;">
                    <span th:text="${reservations.page + 1}">1</span> / <span th:text="${reservations.totalPages}">10</span>
                </span>
                <a th:if="${!reservations.last}"
                   th:href="@{/admin/reservations(page=${reservations.page + 1}, status=${searchStatus}, startDate=${searchStartDate}, endDate=${searchEndDate}, keyword=${searchKeyword})}"
                   class="btn btn-outline" style="padding: 0.25rem 0.75rem;">다음</a>
            </div>
        </div>

        <script th:inline="javascript">
            // 날짜 포맷 헬퍼
            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            // 기본 날짜 설정 (3개월 전 ~ 오늘)
            function setDefaultDates() {
                const today = new Date();
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                const startInputs = document.querySelectorAll('input[name="startDate"], input[name="startDateDesktop"]');
                const endInputs = document.querySelectorAll('input[name="endDate"], input[name="endDateDesktop"]');

                startInputs.forEach(input => {
                    if (!input.value) {
                        input.value = formatDate(threeMonthsAgo);
                    }
                });
                endInputs.forEach(input => {
                    if (!input.value) {
                        input.value = formatDate(today);
                    }
                });
            }

            // 날짜 범위 제한 (최대 1년)
            function validateDateRange(startDate, endDate) {
                if (!startDate || !endDate) return true;

                const start = new Date(startDate);
                const end = new Date(endDate);
                const oneYear = 365 * 24 * 60 * 60 * 1000;

                if (end - start > oneYear) {
                    alert('검색 기간은 최대 1년까지만 설정할 수 있습니다.');
                    return false;
                }
                if (end < start) {
                    alert('종료일이 시작일보다 빠릅니다.');
                    return false;
                }
                return true;
            }

            // 필터 토글
            function toggleFilter() {
                const btn = document.querySelector('.filter-toggle');
                const content = document.getElementById('filterContent');
                btn.classList.toggle('active');
                content.classList.toggle('active');
            }

            // 퀵 필터 설정
            function setDateRange(range) {
                const today = new Date();
                let startDate = new Date();

                switch(range) {
                    case 'today':
                        startDate = today;
                        break;
                    case 'week':
                        const dayOfWeek = today.getDay();
                        const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                        startDate = new Date(today.setDate(diff));
                        today.setDate(today.getDate() + 6);
                        break;
                    case 'month':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        today.setMonth(today.getMonth() + 1);
                        today.setDate(0);
                        break;
                }

                const startInputs = document.querySelectorAll('input[name="startDate"], input[name="startDateDesktop"]');
                const endInputs = document.querySelectorAll('input[name="endDate"], input[name="endDateDesktop"]');

                startInputs.forEach(input => input.value = formatDate(startDate));
                endInputs.forEach(input => input.value = formatDate(new Date()));

                // 퀵 필터 버튼 활성화 표시
                document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }

            // 폼 제출 시 날짜 동기화 및 검증
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                const isMobile = window.innerWidth < 768;
                const startDate = isMobile
                    ? document.querySelector('input[name="startDate"]').value
                    : document.querySelector('input[name="startDateDesktop"]').value;
                const endDate = isMobile
                    ? document.querySelector('input[name="endDate"]').value
                    : document.querySelector('input[name="endDateDesktop"]').value;

                // 날짜 범위 검증
                if (!validateDateRange(startDate, endDate)) {
                    e.preventDefault();
                    return;
                }

                // 모바일/데스크탑 날짜 동기화
                document.querySelectorAll('input[name="startDate"], input[name="startDateDesktop"]').forEach(input => {
                    input.value = startDate;
                    input.name = 'startDate';
                });
                document.querySelectorAll('input[name="endDate"], input[name="endDateDesktop"]').forEach(input => {
                    input.value = endDate;
                    input.name = 'endDate';
                });

                // 중복 파라미터 제거
                document.querySelectorAll('input[name="startDateDesktop"], input[name="endDateDesktop"]').forEach(input => {
                    input.disabled = true;
                });
            });

            // 날짜 입력 변경 시 범위 검증
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.addEventListener('change', function() {
                    const allStartInputs = document.querySelectorAll('input[name="startDate"], input[name="startDateDesktop"]');
                    const allEndInputs = document.querySelectorAll('input[name="endDate"], input[name="endDateDesktop"]');

                    // 같은 역할의 다른 입력과 동기화
                    if (this.name.includes('start')) {
                        allStartInputs.forEach(i => i.value = this.value);
                    } else if (this.name.includes('end')) {
                        allEndInputs.forEach(i => i.value = this.value);
                    }
                });
            });

            // 페이지 로드 시 기본 날짜 설정
            document.addEventListener('DOMContentLoaded', setDefaultDates);
        </script>
    </th:block>
</body>
</html>