<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/customer-layout}"
      lang="ko">
<head>
    <title>예약 수정</title>
    <style>
        .form-input.error {
            border-color: var(--color-danger);
        }
        .form-error {
            font-size: 0.75rem;
            color: var(--color-danger);
            margin-top: 0.25rem;
        }
        .reservation-number-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--color-primary), #022a6e);
            color: #fff;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        @media (max-width: 768px) {
            .type-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .type-btn {
            padding: 0.6rem 0.5rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .type-btn:hover {
            border-color: var(--color-accent);
            background: rgba(40, 167, 225, 0.08);
        }
        .type-btn.selected {
            border-color: var(--color-accent);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(40, 167, 225, 0.3);
            position: relative;
        }
        .type-btn.selected::before {
            content: '✓';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: var(--color-accent);
            color: #fff;
            border-radius: 50%;
            font-size: 0.7rem;
            line-height: 20px;
            font-weight: bold;
        }
        .readonly-info {
            background: var(--color-bg-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .readonly-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--color-border);
        }
        .readonly-info .info-row:last-child {
            border-bottom: none;
        }
        .readonly-info .info-label {
            font-size: 0.85rem;
            color: #666;
        }
        .readonly-info .info-value {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text);
        }
        .edit-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
            color: #856404;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <th:block layout:fragment="page-content">
        <h1 class="mb-3">예약 수정</h1>

        <!-- 예약번호 -->
        <div class="reservation-number-badge">
            예약번호: <span th:text="${reservation.reservationNumber}">R000001</span>
        </div>

        <!-- 수정 안내 -->
        <div class="edit-notice">
            예약 일시 변경은 기존 예약을 취소 후 새로 예약해주세요.
        </div>

        <!-- 에러 메시지 -->
        <div th:if="${error}" class="alert alert-error">
            <span th:text="${error}">에러 메시지</span>
        </div>

        <!-- 수정 불가 정보 (읽기 전용) -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="section-title">예약 정보 (수정 불가)</div>
                <div class="readonly-info">
                    <div class="info-row">
                        <span class="info-label">고객명</span>
                        <span class="info-value" th:text="${reservation.customerName}">홍길동</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">연락처</span>
                        <span class="info-value" th:text="${reservation.phone}">010-1234-5678</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">상담일시</span>
                        <span class="info-value">
                            <span th:text="${#temporals.format(reservation.reservationDate, 'yyyy-MM-dd')}"></span>
                            <span th:text="${#temporals.format(reservation.reservationTime, 'HH:mm')}"></span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <form th:action="@{/customer/reservations/{id}(id=${reservation.id})}" method="post" id="editForm" novalidate>
            <!-- 수정 가능 정보 -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="section-title">수정 가능 정보</div>

                    <div class="form-group">
                        <label class="form-label" for="email">이메일 (선택)</label>
                        <input type="email" class="form-input" id="email" name="email"
                               th:value="${reservation.email}" placeholder="example@email.com">
                        <div class="form-error" id="emailError"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">상담 유형</label>
                        <div class="type-grid">
                            <button type="button" class="type-btn" th:each="type : ${consultationTypes}"
                                    th:data-value="${type}" th:text="${type.description}"
                                    th:classappend="${type == reservation.consultationType} ? 'selected' : ''">유형</button>
                        </div>
                        <input type="hidden" id="consultationType" name="consultationType"
                               th:value="${reservation.consultationType}">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="memo">메모 (선택)</label>
                        <textarea class="form-textarea" id="memo" name="memo" rows="3"
                                  placeholder="상담 관련 메모를 입력하세요 (최대 500자)"
                                  th:text="${reservation.memo}"></textarea>
                    </div>
                </div>
            </div>

            <!-- 버튼 -->
            <div class="form-actions">
                <a th:href="@{/customer/reservations/{id}(id=${reservation.id})}" class="btn btn-outline">취소</a>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </th:block>

    <th:block layout:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const typeBtns = document.querySelectorAll('.type-btn');
                const typeInput = document.getElementById('consultationType');
                const emailInput = document.getElementById('email');

                // ===== 상담유형 버튼 클릭 =====
                typeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        typeBtns.forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        typeInput.value = this.dataset.value;
                    });
                });

                // ===== Email Validation =====
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                function showError(input, message) {
                    input.classList.add('error');
                    const errorEl = document.getElementById(input.id + 'Error');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                }

                function clearError(input) {
                    input.classList.remove('error');
                    const errorEl = document.getElementById(input.id + 'Error');
                    if (errorEl) {
                        errorEl.textContent = '';
                        errorEl.style.display = 'none';
                    }
                }

                function validateEmail() {
                    const value = emailInput.value.trim();
                    if (value && !emailPattern.test(value)) {
                        showError(emailInput, '올바른 이메일 형식이 아닙니다');
                        return false;
                    }
                    clearError(emailInput);
                    return true;
                }

                emailInput.addEventListener('blur', validateEmail);
                emailInput.addEventListener('input', () => clearError(emailInput));

                // 폼 제출
                document.getElementById('editForm').addEventListener('submit', function(e) {
                    if (!validateEmail()) {
                        e.preventDefault();
                        emailInput.focus();
                    }
                });
            });
        </script>
    </th:block>
</body>
</html>
